<!-- 
This file is just for testing purposes
In the teamengine engine root directory:
ant test -Dquery="-mode=test -source=../../test/scripts/myTest.xml -logdir=logs"
-->
<ctl:package
 xmlns="http://www.w3.org/2001/XMLSchema"
 xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
 xmlns:ctl="http://www.occamlab.com/ctl"
 xmlns:parsers="http://www.occamlab.com/te/parsers"
 xmlns:myparsers="http://www.galdosinc.com/myparsers"
 xmlns:saxon="http://saxon.sf.net/"
 xmlns:wfs="http://www.opengis.net/wfs"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xsd="http://www.w3.org/2001/XMLSchema"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="http://www.occamlab.com/ctl xsd/ctl.xsd">

	<!--================-->
	<!-- TEST FUNCTIONS -->
	<!--================-->

	<ctl:test name="ctl:assert-xpath">
		<ctl:param name="expr">An XPath expression.</ctl:param>
		<ctl:param name="doc">A Capabilities document.</ctl:param>
		<ctl:assertion>Test that the given document contains the given xpath assertion.</ctl:assertion>
		<ctl:code>
			<xsl:for-each select="$doc">
				<xsl:choose>
					<xsl:when test="saxon:evaluate($expr)"/>
					<xsl:otherwise>
						<ctl:fail/>
					</xsl:otherwise>
				</xsl:choose>
			</xsl:for-each>
		</ctl:code>
	</ctl:test>
	
	<ctl:test name="ctl:SchematronValidatingParser">
			<ctl:param name="doc"/>
			<ctl:param name="schematronFile"/>
			<ctl:param name="phase"/>
			<ctl:assertion>Validating with SchematronValidatingParser.</ctl:assertion>
			<ctl:code>
				<ctl:message>Calling ctl:CallSchematronValidatingParser:</ctl:message>
				<xsl:variable name="return-value">
					<ctl:call-function name="ctl:CallSchematronValidatingParser">
						<ctl:with-param name="doc"><xsl:copy-of select="$doc"/></ctl:with-param>
						<ctl:with-param name="schematronFile" select="string($schematronFile)"/>
						<ctl:with-param name="phase" select="string($phase)"/>
					</ctl:call-function>
				</xsl:variable>
				<xsl:if test="$return-value='false'">
					<ctl:fail/>
				</xsl:if>	
			</ctl:code>
	</ctl:test>	

	<ctl:function name="ctl:CallSchematronValidatingParser">
		<ctl:param name="doc"/>
		<ctl:param name="schematronFile"/>
		<ctl:param name="phase"/>
		<ctl:description>Afunction to call the schematon validator.</ctl:description>
		<ctl:java class="com.occamlab.te.parsers.SchematronValidatingParser" method="checkSchematronRules" initialized="true"/>
	</ctl:function>		
	
	<!--=================-->
	<!-- CUSTOM PARSERS -->
	<!--=================-->		
	
	<ctl:parser name="myparsers:SchematronValidatingParser">
		<ctl:param name="schema_link"/>
		<ctl:java class="com.occamlab.te.parsers.SchematronValidatingParser" method="parse" initialized="true"/>
	</ctl:parser>	
	
	<ctl:parser name="myparsers:SchematronValidatingParser2">
		<ctl:java class="com.occamlab.te.parsers.SchematronValidatingParser" method="parse" initialized="true">
			<ctl:with-param name="schema_link">
					<parsers:schemas>
						<parsers:schema type="resource" phase="Default">sch/wfs/1.1.0/WFSCapabilities.sch</parsers:schema>
					</parsers:schemas>
			</ctl:with-param>
		</ctl:java>
	</ctl:parser>	
	
	<!--===============-->
	<!-- GENERAL TESTS -->
	<!--===============-->	
	
	<ctl:test name="ctl:getCapabilities">
		<ctl:assertion>GetCapabilities using HTTP-Get</ctl:assertion>
		<ctl:code>
			<xsl:variable name="url">http://vancouver1.demo.galdosinc.com/wfs/http</xsl:variable>
			<xsl:variable name="cap-doc">
				<ctl:request>
					<ctl:url><xsl:value-of select="$url"/></ctl:url>
					<ctl:method>get</ctl:method>
					<ctl:param name="service">WFS</ctl:param>
				    <ctl:param name="request">GetCapabilities</ctl:param>
				    <ctl:param name="version">1.0.0</ctl:param>
					<!-- NOTE: CAN ONLY HAVE ONE INLINE PARSER -->					
					<parsers:XMLValidatingParser>
						<parsers:schemas>
								<parsers:schema type="resource">xsd/wfs-1.0.0.xsd</parsers:schema>
						</parsers:schemas>
					</parsers:XMLValidatingParser>
					<!--<myparsers:SchematronValidatingParser>
						<parsers:schemas>
							<parsers:schema type="resource" phase="Default">sch/wfs/1.1.0/WFSCapabilities.sch</parsers:schema>
						</parsers:schemas>
					</myparsers:SchematronValidatingParser>-->
				<!--<myparsers:SchematronValidatingParser2/>-->
				</ctl:request>
			</xsl:variable>
	
			<xsl:if test="not($cap-doc/*)">
				<ctl:fail/>
			</xsl:if>
	
			<xsl:variable name="expression">//wfs:WFS_Capabilities</xsl:variable>
			<ctl:call-test name="ctl:assert-xpath">
				<ctl:with-param name="expr" select="$expression"/>
				<ctl:with-param name="doc" select="$cap-doc"/>
			</ctl:call-test>	
			
			<ctl:call-test name="ctl:SchematronValidatingParser">
				<ctl:with-param name="doc" select="$cap-doc"/>
				<ctl:with-param name="schematronFile">sch/wfs/1.1.0/WFSCapabilities.sch</ctl:with-param>
				<ctl:with-param name="phase">Default</ctl:with-param>
			</ctl:call-test>
				
		</ctl:code>
	</ctl:test>
	
	<!--=================-->
	<!-- MAIN TEST DRIVER -->
	<!--=================-->		
	
	<ctl:test name="ctl:main">
		<ctl:assertion>Test a number of example queries.</ctl:assertion>
		<ctl:code>
			<ctl:call-test name="ctl:getCapabilities"/>
		</ctl:code>
	</ctl:test>	
	
	<ctl:suite name="ctl:myTestSuite">
		<ctl:title>My Test Suite</ctl:title>
		<ctl:description>A number of tests to explore the workings of the CITE language and Team engine.</ctl:description>
		<ctl:starting-test>ctl:main</ctl:starting-test>
	</ctl:suite>
</ctl:package>


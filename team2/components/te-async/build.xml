<?xml version="1.0" encoding="UTF-8"?>
<project name="te-async" default="jar" basedir=".">

  <!-- Load property overrides from user home -->
  <property file="${user.home}/${ant.project.name}.properties"/>
  <!-- provide access to OS-specific environment variables -->
  <property environment="env"/>
  <property name="env.HOSTNAME" value="${env.COMPUTERNAME}"/>
  <property file="build.properties"/>

  <path id="compile.classpath">
    <fileset dir="${lib.dir}" includes="*.jar"/>
    <fileset dir="${engine.lib.dir}" includes="*.jar"/>
    <fileset dir="${engine.dist.dir}" includes="*.jar"/>
    <fileset dir="${manager.lib.dir}" includes="*.jar"/>
  </path>

  <path id="test.classpath">
    <pathelement location="${common.lib.dir}/junit-4.3.1.jar"/>
    <pathelement location="${common.lib.dir}/resolver-1.2.jar"/>
  </path>

  <target name="jar" depends="compile"
    description="Creates the JAR file for distribution.">
    <jar jarfile="${dist.dir}/${ant.project.name}.jar"
         basedir="${build.classes.dir}" />
  </target>

  <target name="clean"
    description="Deletes all artifacts generated by the build.">
    <delete dir="${build.dir}"/>
    <delete dir="${dist.dir}"/>
  </target>

  <target name="javadocs" depends="compile"
    description="Generates the API documentation for the module.">
    <mkdir dir="${javadoc.dir}"/>
    <javadoc
      destdir="${javadoc.dir}"
      sourcepath="${src.java.dir}"
      packagenames="net.sf.teamengine.async.*"
      source="1.5"
      overview="${docs.dir}/overview.html"
      author="true"
      version="true"
      use="true"
      nodeprecated="false"
      nodeprecatedlist="false"
      noindex="false"
      nonavbar="false"
      notree="false"
      splitindex="false">
        <classpath refid="compile.classpath"/>
        <link href="http://java.sun.com/j2se/1.5.0/docs/api/"/>
    </javadoc>
  </target>

  <target name="test" depends="compile-tests" description="Run unit tests for module.">

    <junit fork="true" printsummary="yes"
      errorProperty="test.failure"
      failureProperty="test.failure">

      <sysproperty key="xml.catalog.files" file="${src.test.dir}/data/catalog.xml" />
      <sysproperty key="xml.catalog.verbosity" value="4" />
      <classpath>
        <pathelement location="${build.classes.dir}"/>
        <pathelement location="${build.tests.dir}"/>
        <path refid="test.classpath"/>
        <path refid="compile.classpath"/>
      </classpath>
      <assertions>
        <enable package="net.sf.teamengine"/>
      </assertions>
      <formatter type="plain" />
      <batchtest todir="${build.tests.dir}">
        <fileset dir="${build.tests.dir}" />
      </batchtest>
    </junit>

    <fail if="test.failure"
        message="Tests failed. Check unit test report for details." />
  </target>

  <!-- internal targets -->
  <target name="init">
    <tstamp />
  </target>

  <target name="prepare" depends="init">
    <mkdir dir="${build.classes.dir}" />
    <mkdir dir="${dist.dir}" />
  </target>

  <target name="compile" depends="prepare">
    <javac
      srcdir="${src.java.dir}"
      destdir="${build.classes.dir}"
      includeAntRuntime="yes"
      debug="${build.debug}"
      optimize="${build.optimize}">
      <classpath refid="compile.classpath"/>
      <compilerarg compiler="javac1.5" value="-Xlint:none" />
    </javac>
  </target>

  <target name="compile-tests" depends="compile">
    <mkdir dir="${build.tests.dir}"/>
    <javac destdir="${build.tests.dir}"
           includeAntRuntime="yes"
           srcdir="${src.test.dir}">
      <classpath>
        <path refid="test.classpath"/>
        <path refid="compile.classpath"/>
        <pathelement location="${build.classes.dir}"/>
      </classpath>
    </javac>
  </target>
</project>
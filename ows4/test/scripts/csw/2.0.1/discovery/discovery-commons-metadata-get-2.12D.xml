<?xml version="1.0" encoding="UTF-8"?>
<ctl:package
 xmlns="http://www.occamlab.com/ctl"
 xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
 xmlns:ctl="http://www.occamlab.com/ctl"
 xmlns:parsers="http://www.occamlab.com/te/parsers"
 xmlns:myparsers="http://www.galdosinc.com/myparsers"
 xmlns:saxon="http://saxon.sf.net/"
 xmlns:csw="http://www.opengis.net/cat/csw"
 xmlns:ows="http://www.opengis.net/ows"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xsd="http://www.w3.org/2001/XMLSchema"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="http://www.occamlab.com/ctl ../../../../../apps/engine/resources/com/occamlab/te/schemas/ctl.xsd">

	<test name="csw:discovery-commons-metadata-get-2.12D">
      <param name="VAR_CSW_GET_CAPABILITIES_HTTP_GET_URL"/>
      <assertion>In the event that a GetCapabilities request cannot be processed for any reason, the response entity shall include an exception report. The exception code must be one of those listed in Table 5.</assertion>
      <comment>This test issues a GetCapabilities request using HTTP GET to the CSW server under test. The exception InvalidUpdateSequence is raised when the the UpdateSequence value is higher than the current UpdateSequence value, and should result in a service exception. No 'locator' is needed.</comment>
      <link>csw-2.0.1#discovery-commons-metadata-get-2.12</link>
		<code>
		
			<xsl:variable name="request1">
				<request>
					<url>
						<xsl:value-of select="$VAR_CSW_GET_CAPABILITIES_HTTP_GET_URL"/>
					</url>
					<method>get</method>
					<param name="service">CSW</param>
					<param name="version">2.0.1</param>
					<param name="request">GetCapabilities</param>
					<param name="updatesequence">10000.00</param>
					<myparsers:XMLValidatingParser.ServiceException/>
				</request>
			</xsl:variable>
			
			<xsl:if test="not($request1/*)">
				<ctl:fail/>
			</xsl:if>

			<xsl:if test="$request1/*">
				<xsl:variable name="expression">//ows:ExceptionReport</xsl:variable>
				<ctl:call-test name="ctl:assert-xpath">
					<ctl:with-param name="expr" select="$expression"/>
					<ctl:with-param name="doc" select="$request1"/>
				</ctl:call-test>
			</xsl:if>	
		
		    <xsl:if test="$request1/*">
				<ctl:call-test name="ctl:SchematronValidatingParser">
					<ctl:with-param name="doc" select="$request1"/>
					<ctl:with-param name="schematronFile">sch/csw/2.0.1/CSWServiceExceptionReport.sch</ctl:with-param>
					<ctl:with-param name="phase">InvalidUpdateSequence</ctl:with-param>
				</ctl:call-test>				
			</xsl:if>					
				
		</code>
	</test>
</ctl:package>

<?xml version="1.0" encoding="UTF-8"?>
<ctl:package
 xmlns="http://www.occamlab.com/ctl"
 xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
 xmlns:ctl="http://www.occamlab.com/ctl"
 xmlns:parsers="http://www.occamlab.com/te/parsers"
 xmlns:myparsers="http://teamengine.sourceforge.net/parsers"
 xmlns:saxon="http://saxon.sf.net/"
 xmlns:csw="http://www.opengis.net/cat/csw"
 xmlns:ows="http://www.opengis.net/ows"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:xsd="http://www.w3.org/2001/XMLSchema"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="http://www.occamlab.com/ctl ../../../../../apps/engine/resources/com/occamlab/te/schemas/ctl.xsd">

	<test name="csw:discovery.commons.transaction.1">
      <param name="csw.GetCapabilities.get.url"/>
      <assertion>All OGC web services must generate an exception report in response to an invalid request or whenever a condition arises that prevents request processing. A valid XML response entity must conform to the declaration of the ows:ExceptionReport.</assertion>
      <comment>This test issues a Transaction request using HTTP GET to the CSW server under test. The exception OperationNotSupported is raised when the the operation requested is not supported by the server, the name of the unsupported operation is expected in the 'locator' parameter and the value of the exceptionCode is 'OperationNotSupported' to be valid, otherwise the test fails.</comment>
      <link>OGC 05-008c1, 8.5, p.35</link>
		<code>
					
			<xsl:variable name="request1">
				<request>
					<url>
						<xsl:value-of select="$csw.GetCapabilities.get.url"/>
					</url>
					<method>get</method>
					<param name="service">http://www.opengis.net/cat/csw</param>
					<param name="version">2.0.1</param>
					<param name="request">Transaction</param>
					<!--<myparsers:XMLValidatingParser.ServiceException/>-->
				</request>
			</xsl:variable>
			
			<xsl:if test="not($request1/*)">
				<ctl:fail/>
			</xsl:if>

			<xsl:if test="$request1/*">
				<xsl:variable name="expression">//ows:ExceptionReport</xsl:variable>
				<ctl:call-test name="ctl:assert-xpath">
					<ctl:with-param name="expr" select="$expression"/>
					<ctl:with-param name="doc" select="$request1"/>
				</ctl:call-test>
			</xsl:if>	
		
		    <xsl:if test="$request1/*">
				<ctl:call-test name="ctl:SchematronValidatingParser">
					<ctl:with-param name="doc" select="$request1"/>
					<ctl:with-param name="schematronFile">sch/ows/1.0.0/ExceptionReport.sch</ctl:with-param>
					<ctl:with-param name="phase">OperationNotSupported</ctl:with-param>
				</ctl:call-test>				
			</xsl:if>					
				
		</code>
	</test>
</ctl:package>
